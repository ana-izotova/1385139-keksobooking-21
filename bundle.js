(()=>{"use strict";window.utils={errorLoadHandler:e=>{const t=document.createElement("div");t.style.cssText="\n  z-index: 100;\n  width: 300px;\n  margin: 0 auto;\n  padding: 25px;\n  text-align: center;\n  background-color: #f0f0ea;\n  border: #ff5635 2px solid;\n  border-radius: 25px;\n  box-shadow: 0 0 40px #ff5635;\n  color: #ff5635;\n  font-size: 20px;\n  position: absolute;\n  top: 50%;\n  left: 50%;\n  transform: translateX(-50%);\n  ",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)}},(()=>{const e="https://21.javascript.pages.academy/keksobooking/data",t="https://21.javascript.pages.academy/keksobooking",o="GET",r="POST",n=(e,t,o)=>{e.responseType="json",e.addEventListener("load",(()=>{200===e.status?t(e.response):o(`Статус ответа: ${e.status} ${e.statusText}`)})),e.addEventListener("error",(()=>{o("Произошла ошибка соединения")})),e.addEventListener("timeout",(()=>{o(`Запрос не успел выполниться за ${e.timeout} мс`)})),e.timeout=1e4};window.server={load:(t,r)=>{const a=new XMLHttpRequest;a.open(o,e),n(a,t,r),a.send()},send:(e,o,a)=>{const s=new XMLHttpRequest;s.open(r,t),n(s,o,a),s.send(e)}}})(),window.server.load((e=>{window.data=e.filter((e=>e.offer))}),window.utils.errorLoadHandler),window.debounce=e=>{let t=null;return(...o)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(o)}),500)}},(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__pins"),o=e.querySelector(".map__pins"),r=document.querySelector("#pin").content.querySelector(".map__pin"),n=()=>{const e=o.querySelectorAll(".map__pin:not(.map__pin--main)");e&&e.forEach((e=>e.remove()))};window.pins={render:e=>{const a=(e=>{const t=document.createDocumentFragment();return e.forEach((e=>{const o=(e=>{const{author:{avatar:t},offer:{title:o},location:{x:n,y:a}}=e,s=r.cloneNode(!0),d=s.querySelector("img");return s.style.left=n-25+"px",s.style.top=a-70+"px",d.src=t,d.alt=o,s})(e);t.appendChild(o)})),t})(e);n(),window.cards.removePopup(),t.appendChild(a),o.querySelectorAll(".map__pin:not(.map__pin--main)").forEach(((t,o)=>{t.addEventListener("click",((e,t,o)=>()=>{window.cards.openPopup(o[t],e)})(t,o,e))}))},remove:n,setActiveModificator:e=>{e.classList.add("map__pin--active")},removeActiveModificator:()=>{const t=e.querySelector(".map__pin--active");t&&t.classList.remove("map__pin--active")}}})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__filters-container"),o=window.pins.setActiveModificator,r=window.pins.removeActiveModificator,n=document.querySelector("#card").content.querySelector(".map__card"),a={palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"},s=()=>{const t=e.querySelector(".map__card");t&&e.removeChild(t)},d=o=>{const{author:{avatar:r},offer:{title:d,address:i,price:c,type:l,rooms:u,guests:m,checkin:p,checkout:v,features:f,description:w,photos:y}}=o;s();const h=n.cloneNode(!0),E=h.querySelector(".popup__avatar");E.src=r||E.remove();const _=h.querySelector(".popup__title");_.textContent=d||_.remove();const S=h.querySelector(".popup__text--address");S.textContent=i||S.remove();const g=h.querySelector(".popup__text--price");g.textContent=c?c+"₽/ночь":g.remove();const L=h.querySelector(".popup__type");L.textContent=l?a[l]:L.remove();let q=1===u?"комната":"комнаты",b=1===m?"гостя":"гостей";const k=h.querySelector(".popup__text--capacity");k.textContent=u?`${u} ${q} для ${m} ${b}`:k.remove();const C=h.querySelector(".popup__text--time");C.textContent=p?`Заезд после ${p}, выезд до ${v}`:C.remove();const x=h.querySelector(".popup__description");x.textContent=w||x.remove(),((e,t)=>{const o=e.querySelector(".popup__features");t.length>0?[...o.querySelectorAll(".popup__feature")].filter((e=>!t.some((t=>e.className.includes("--"+t))))).forEach((e=>o.removeChild(e))):o.remove()})(h,f),((e,t)=>{const o=e.querySelector(".popup__photos");if(t.length>0){const e=o.querySelector(".popup__photo"),r=document.createDocumentFragment();t.forEach((t=>{const o=e.cloneNode(!0);o.src=t,r.appendChild(o)})),e.replaceWith(r)}else o.remove()})(h,y),e.insertBefore(h,t)},i=e=>{"Escape"===e.key&&(e.preventDefault(),c())},c=()=>{r(),s(),document.removeEventListener("keydown",i),document.removeEventListener("click",c)};window.cards={create:d,openPopup:(t,n)=>{s(),r(),d(t),o(n);const a=e.querySelector(".map__card").querySelector(".popup__close");document.addEventListener("keydown",i),a.addEventListener("click",c)},removePopup:s}})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__pin--main"),o={X:t.style.left,Y:t.style.top};window.mainPin={move:o=>{o.preventDefault();let r={X:o.pageX,Y:o.pageY};const n=o=>{o.preventDefault();const n={TOP:130,BOTTOM:630,left:-Math.round(t.offsetWidth/2),right:e.offsetWidth-t.offsetWidth/2},a=r.X-o.pageX,s=r.Y-o.pageY;r.X=o.pageX,r.Y=o.pageY;let d=t.offsetTop-s,i=t.offsetLeft-a;i=i<n.left?n.left:i,i=i>n.right?n.right:i,d=d<n.TOP?n.TOP:d,d=d>n.BOTTOM?n.BOTTOM:d,t.style.top=d+"px",t.style.left=i+"px",window.form.setAddress(!0)},a=e=>{e.preventDefault(),document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",a)};document.addEventListener("mousemove",n),document.addEventListener("mouseup",a)},InitialPosition:o,setCoordinates:(e=!1)=>{const o={X:t.style.left,Y:t.style.top},r=Math.round(parseInt(o.X,10)+32.5);let n=Math.round(parseInt(o.Y,10)+32.5);return e&&(n+=Math.round(32.5)+22),[r,n]},setDefaultPosition:()=>{t.style.cssText=`left: ${o.X}; top: ${o.Y}`}}})(),(()=>{const e=document.querySelector("#error").content.querySelector(".error").cloneNode(!0),t=e.querySelector(".error__button"),o=e=>{"Escape"===e.key&&(e.preventDefault(),r())},r=()=>{document.body.querySelector(".error").remove(),document.removeEventListener("keydown",o),document.removeEventListener("click",r),t.removeEventListener("click",r)};window.formUploadError={submitHandler:()=>{document.body.insertAdjacentElement("afterbegin",e),t.addEventListener("click",r),document.addEventListener("keydown",o),document.addEventListener("click",r)}}})(),(()=>{const e=document.querySelector("#success").content.querySelector(".success").cloneNode(!0),t=e=>{"Escape"===e.key&&(e.preventDefault(),o())},o=()=>{document.body.querySelector(".success").remove(),document.removeEventListener("keydown",t),document.removeEventListener("click",o)};window.formUploadSuccess={submitHandler:()=>{document.body.insertAdjacentElement("afterbegin",e),document.addEventListener("keydown",t),document.addEventListener("click",o),window.pageState.deactivate()}}})(),(()=>{const e=["gif","jpg","jpeg","png"],t=document.querySelector(".ad-form"),o=t.querySelector(".ad-form__field input[type=file]"),r=t.querySelector(".ad-form-header__preview img"),n=t.querySelector(".ad-form__upload input[type=file]"),a=t.querySelector(".ad-form__photo"),s=r.src,d=(t,o)=>()=>{const n=t.files[0],s=n.name.toLowerCase();if(e.some((e=>s.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{o===r&&(r.src=e.result),o===a&&(a.innerHTML=`<img src='${e.result}' width='70' height='70' alt='Фотография жилья'>`)})),e.readAsDataURL(n)}};window.imageUpload={addHandlers:()=>{o.addEventListener("change",d(o,r)),n.addEventListener("change",d(n,a))},removeHandlers:()=>{o.removeEventListener("change",d(o,r)),n.removeEventListener("change",d(n,a))},setDefaultAvatar:()=>{r.src=s},removeUploadedPhoto:()=>{a.innerHTML=""}}})(),(()=>{const e=document.querySelector(".ad-form"),t=e.querySelector("#title"),o=e.querySelector("#price"),r=e.querySelector("#type"),n=e.querySelector("#timein"),a=e.querySelector("#timeout"),s=e.querySelector("#room_number"),d=e.querySelector("#capacity"),i=d.querySelectorAll("option"),c={BUNGALOW:0,FLAT:1e3,HOUSE:5e3,PALACE:1e4,MAX_PRICE:1e6},l={1:["1"],2:["1","2"],3:["1","2","3"],100:["0"]},u=document.querySelector("#address"),m=e=>{const t=window.mainPin.setCoordinates(e);u.value=t.join(", ")};u.setAttribute("readonly",!0);const p=()=>{const e=t.value.length;e<30?t.setCustomValidity("Ещё "+(30-e)+" символов"):e>100?t.setCustomValidity("Удалите лишние "+(e-100)+" символов"):t.setCustomValidity(""),t.reportValidity()},v=()=>{const e=c[r.value.toUpperCase()];o.setAttribute("min",e),o.placeholder=e};v();const f=()=>{v();const e=Number(o.getAttribute("min")),t=Number(o.value);t<e?o.setCustomValidity("Минимальная стоимость - "+e):t>c.MAX_PRICE?o.setCustomValidity("Стоимость не может быть выше "+c.MAX_PRICE):o.setCustomValidity(""),o.reportValidity()},w=()=>{return e=s.value,i.forEach((t=>{t.disabled=!l[e].includes(t.value)})),void(d.value=e>3?0:e);var e};w();const y=()=>{a.value=n.value},h=()=>{n.value=a.value};window.form={setAddress:m,submitHandler:t=>{t.preventDefault();const o=new FormData(e);window.server.send(o,window.formUploadSuccess.submitHandler,window.formUploadError.submitHandler),e.removeEventListener("submit",window.form.submitHandler)},addValidationHandlers:()=>{t.addEventListener("input",p),r.addEventListener("change",f),o.addEventListener("input",f),n.addEventListener("change",y),a.addEventListener("change",h),s.addEventListener("change",w)},removeValidationHandlers:()=>{t.removeEventListener("input",p),r.removeEventListener("change",f),o.removeEventListener("input",f),n.removeEventListener("change",y),a.removeEventListener("change",h),s.removeEventListener("change",w)},reset:()=>{e.reset(),m(),v(),w(),window.imageUpload.setDefaultAvatar(),window.imageUpload.removeUploadedPhoto(),e.removeEventListener("submit",window.form.submitHandler)}}})(),(()=>{const e=document.querySelector(".map__filters"),t=e.querySelector("#housing-type"),o=e.querySelector("#housing-price"),r=e.querySelector("#housing-rooms"),n=e.querySelector("#housing-guests"),a=e.querySelector("#housing-features"),s=[t,o,r,n],d=[e=>{const o=t.value;return"any"===o||e.offer.type===o},e=>{switch(o.value){case"middle":return e.offer.price>=1e4&&e.offer.price<=5e4;case"low":return e.offer.price<1e4;case"high":return e.offer.price>5e4;default:return!0}},e=>{const t=r.value;return"any"===t||e.offer.rooms===Number(t)},e=>{const t=n.value;return"any"===t||e.offer.guests===Number(t)},e=>{const t=a.querySelectorAll(":checked");return 0===t.length||0===[...t].map((e=>e.value)).filter((t=>!e.offer.features.includes(t))).length}],i=window.debounce((()=>{const e=window.data,t=d.reduce(((e,t)=>e.filter(t)),e).slice(0,5);window.pins.render(t)}));window.filters={addChangeHandler:()=>{e.addEventListener("change",i)},removeChangeHandler:()=>{e.removeEventListener("change",i)},reset:()=>{s.forEach((e=>{e.value="any"})),a.querySelectorAll("[type=checkbox]").forEach((e=>{e.checked=!1}))}}})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector(".ad-form"),o=t.querySelector(".ad-form__reset"),r=t.querySelectorAll("fieldset"),n=e.querySelector(".map__filters"),a=e.querySelector(".map__pin--main"),s=e=>{0===e.button&&l()},d=e=>{"Enter"===e.key&&l()},i=e=>{[...e].forEach((e=>e.disabled=!1))},c=e=>{[...e].forEach((e=>e.disabled=!0))},l=()=>{i(r),i(n.children),t.classList.remove("ad-form--disabled"),e.classList.remove("map--faded");const c=window.data.slice(0,5);window.form.setAddress(!0),window.pins.render(c),c&&window.filters.addChangeHandler(),window.form.addValidationHandlers(),t.addEventListener("submit",window.form.submitHandler),a.removeEventListener("mousedown",s),a.removeEventListener("keydown",d),a.addEventListener("mousedown",window.mainPin.move),o.addEventListener("click",u),window.imageUpload.addHandlers()},u=()=>{c(r),c(n.children),a.addEventListener("mousedown",s),a.addEventListener("keydown",d),window.form.removeValidationHandlers(),window.pins.remove(),window.cards.removePopup(),t.classList.add("ad-form--disabled"),e.classList.add("map--faded"),window.mainPin.setDefaultPosition(),a.removeEventListener("mousedown",window.mainPin.move),window.filters.removeChangeHandler(),window.form.reset(),window.filters.reset(),o.removeEventListener("click",u),window.imageUpload.removeHandlers()};u(),window.pageState={deactivate:u}})()})();