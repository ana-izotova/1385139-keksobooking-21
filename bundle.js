(()=>{"use strict";window.utils={errorLoadHandler:e=>{const t=document.createElement("div");t.style.cssText="\n  z-index: 100;\n  width: 300px;\n  margin: 0 auto;\n  padding: 25px;\n  text-align: center;\n  background-color: #f0f0ea;\n  border: #ff5635 2px solid;\n  border-radius: 25px;\n  box-shadow: 0 0 40px #ff5635;\n  color: #ff5635;\n  font-size: 20px;\n  position: absolute;\n  top: 50%;\n  left: 50%;\n  transform: translateX(-50%);\n  ",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)}},(()=>{const e="https://21.javascript.pages.academy/keksobooking/data",t="https://21.javascript.pages.academy/keksobooking",o={GET:"GET",POST:"POST"};window.server={HttpRequestMethod:o,configure:(r,n,s=o.GET,d)=>{const i=new XMLHttpRequest;i.responseType="json",s===o.POST?(i.open(o.POST,t),i.send(d)):(i.open(o.GET,e),i.send()),i.addEventListener("load",(()=>{200===i.status?r(i.response):n(`Статус ответа: ${i.status} ${i.statusText}`)})),i.addEventListener("error",(()=>{n("Произошла ошибка соединения")})),i.addEventListener("timeout",(()=>{n(`Запрос не успел выполниться за ${i.timeout} мс`)})),i.timeout=1e4}}})(),window.server.configure((e=>{window.data=e.filter((e=>e.offer))}),window.utils.errorLoadHandler,window.server.HttpRequestMethod.GET),window.debounce=e=>{let t=null;return(...o)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(o)}),500)}},(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__pins"),o=e.querySelector(".map__pins"),r=document.querySelector("#pin").content.querySelector(".map__pin"),n=()=>{const e=o.querySelectorAll(".map__pin:not(.map__pin--main)");e&&e.forEach((e=>e.remove()))};window.pins={render:e=>{const s=(e=>{const t=document.createDocumentFragment();return e.forEach((e=>{const o=(e=>{const{author:{avatar:t},offer:{title:o},location:{x:n,y:s}}=e,d=r.cloneNode(!0),i=d.querySelector("img");return d.style.left=n-25+"px",d.style.top=s-70+"px",i.src=t,i.alt=o,d})(e);t.appendChild(o)})),t})(e);n(),window.cards.removePopup(),t.appendChild(s),o.querySelectorAll(".map__pin:not(.map__pin--main)").forEach(((t,o)=>{t.addEventListener("click",((e,t,o)=>()=>{window.cards.openPopup(o[t],e)})(t,o,e))}))},remove:n,setActiveModificator:e=>{e.classList.add("map__pin--active")},removeActiveModificator:()=>{const t=e.querySelector(".map__pin--active");t&&t.classList.remove("map__pin--active")}}})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__filters-container"),o=window.pins.setActiveModificator,r=window.pins.removeActiveModificator,n=document.querySelector("#card").content.querySelector(".map__card"),s={palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"},d=()=>{const t=e.querySelector(".map__card");t&&e.removeChild(t)},i=o=>{const{author:{avatar:r},offer:{title:i,address:a,price:c,type:l,rooms:u,guests:m,checkin:p,checkout:v,features:f,description:w,photos:y}}=o;d();const h=n.cloneNode(!0),E=h.querySelector(".popup__avatar");E.src=r||E.remove();const _=h.querySelector(".popup__title");_.textContent=i||_.remove();const S=h.querySelector(".popup__text--address");S.textContent=a||S.remove();const g=h.querySelector(".popup__text--price");g.textContent=c?c+"₽/ночь":g.remove();const q=h.querySelector(".popup__type");q.textContent=l?s[l]:q.remove();let L=1===u?"комната":"комнаты",b=1===m?"гостя":"гостей";const k=h.querySelector(".popup__text--capacity");k.textContent=u?`${u} ${L} для ${m} ${b}`:k.remove();const C=h.querySelector(".popup__text--time");C.textContent=p?`Заезд после ${p}, выезд до ${v}`:C.remove();const x=h.querySelector(".popup__description");x.textContent=w||x.remove(),((e,t)=>{const o=e.querySelector(".popup__features");t.length>0?[...o.querySelectorAll(".popup__feature")].filter((e=>!t.some((t=>e.className.includes("--"+t))))).forEach((e=>o.removeChild(e))):o.remove()})(h,f),((e,t)=>{const o=e.querySelector(".popup__photos");if(t.length>0){const e=o.querySelector(".popup__photo"),r=document.createDocumentFragment();t.forEach((t=>{const o=e.cloneNode(!0);o.src=t,r.appendChild(o)})),e.replaceWith(r)}else o.remove()})(h,y),e.insertBefore(h,t)},a=e=>{"Escape"===e.key&&(e.preventDefault(),c())},c=()=>{r(),d(),document.removeEventListener("keydown",a),document.removeEventListener("click",c)};window.cards={create:i,openPopup:(t,n)=>{d(),r(),i(t),o(n);const s=e.querySelector(".map__card").querySelector(".popup__close");document.addEventListener("keydown",a),s.addEventListener("click",c)},removePopup:d}})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__pin--main"),o={TOP:130,BOTTOM:630},r={X:t.style.left,Y:t.style.top};window.mainPin={move:r=>{r.preventDefault();const{TOP:n,BOTTOM:s}=o,d=-Math.round(t.offsetWidth/2),i=e.offsetWidth-t.offsetWidth/2;let a={X:r.pageX,Y:r.pageY};const c=e=>{e.preventDefault();const o=a.X-e.pageX,r=a.Y-e.pageY;a.X=e.pageX,a.Y=e.pageY;let c=t.offsetTop-r,l=t.offsetLeft-o;l=l<d?d:l,l=l>i?i:l,c=c<n?n:c,c=c>s?s:c,t.style.top=c+"px",t.style.left=l+"px",window.form.setAddress(!0)},l=e=>{e.preventDefault(),document.removeEventListener("mousemove",c),document.removeEventListener("mouseup",l)};document.addEventListener("mousemove",c),document.addEventListener("mouseup",l)},InitialPosition:r,setCoordinates:(e=!1)=>{const o={X:t.style.left,Y:t.style.top},r=Math.round(parseInt(o.X,10)+32.5);let n=Math.round(parseInt(o.Y,10)+32.5);return e&&(n+=Math.round(32.5)+22),[r,n]},setDefaultPosition:()=>{t.style.cssText=`left: ${r.X}; top: ${r.Y}`}}})(),(()=>{const e=document.querySelector("#error").content.querySelector(".error").cloneNode(!0),t=e.querySelector(".error__button"),o=e=>{"Escape"===e.key&&(e.preventDefault(),r())},r=()=>{document.body.querySelector(".error").remove(),document.removeEventListener("keydown",o),document.removeEventListener("click",r),t.removeEventListener("click",r)};window.formUploadError={submitHandler:()=>{document.body.insertAdjacentElement("afterbegin",e),t.addEventListener("click",r),document.addEventListener("keydown",o),document.addEventListener("click",r)}}})(),(()=>{const e=document.querySelector("#success").content.querySelector(".success").cloneNode(!0),t=e=>{"Escape"===e.key&&(e.preventDefault(),o())},o=()=>{document.body.querySelector(".success").remove(),document.removeEventListener("keydown",t),document.removeEventListener("click",o)};window.formUploadSuccess={submitHandler:()=>{document.body.insertAdjacentElement("afterbegin",e),document.addEventListener("keydown",t),document.addEventListener("click",o),window.pageState.deactivate()}}})(),(()=>{const e=["gif","jpg","jpeg","png"],t=document.querySelector(".ad-form"),o=t.querySelector(".ad-form__field input[type=file]"),r=t.querySelector(".ad-form-header__preview img"),n=t.querySelector(".ad-form__upload input[type=file]"),s=t.querySelector(".ad-form__photo"),d=r.src,i=(t,o)=>()=>{const n=t.files[0],d=n.name.toLowerCase();if(e.some((e=>d.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{const t=e.result;o===r&&(r.src=t),o===s&&s.insertAdjacentHTML("afterbegin",`<img src='${t}' width='70' height='70' alt='Фотография жилья'>`)})),e.readAsDataURL(n)}};window.imageUpload={addHandlers:()=>{o.addEventListener("change",i(o,r)),n.addEventListener("change",i(n,s))},removeHandlers:()=>{o.removeEventListener("change",i(o,r)),n.removeEventListener("change",i(n,s))},reset:()=>{r.src=d,s.children.length>0&&s.querySelector("img").remove()}}})(),(()=>{const e=document.querySelector(".ad-form"),t=e.querySelector("#title"),o=e.querySelector("#price"),r=e.querySelector("#type"),n=e.querySelector("#timein"),s=e.querySelector("#timeout"),d=e.querySelector("#room_number"),i=e.querySelector("#capacity"),a=i.querySelectorAll("option"),c={BUNGALOW:0,FLAT:1e3,HOUSE:5e3,PALACE:1e4,MAX_PRICE:1e6},l={1:["1"],2:["1","2"],3:["1","2","3"],100:["0"]},u=document.querySelector("#address"),m=e=>{const t=window.mainPin.setCoordinates(e);u.value=t.join(", ")};u.setAttribute("readonly",!0);const p=()=>{const e=t.value.length;e<30?t.setCustomValidity("Ещё "+(30-e)+" символов"):e>100?t.setCustomValidity("Удалите лишние "+(e-100)+" символов"):t.setCustomValidity(""),t.reportValidity()},v=()=>{const e=c[r.value.toUpperCase()];o.setAttribute("min",e),o.placeholder=e};v();const f=()=>{v();const e=Number(o.getAttribute("min")),t=Number(o.value);t<e?o.setCustomValidity("Минимальная стоимость - "+e):t>c.MAX_PRICE?o.setCustomValidity("Стоимость не может быть выше "+c.MAX_PRICE):o.setCustomValidity(""),o.reportValidity()},w=()=>{return e=d.value,a.forEach((t=>{t.disabled=!l[e].includes(t.value)})),void(i.value=e>3?0:e);var e};w();const y=()=>{s.value=n.value},h=()=>{n.value=s.value};window.form={setAddress:m,submitHandler:t=>{t.preventDefault();const o=new FormData(e);window.server.configure(window.formUploadSuccess.submitHandler,window.formUploadError.submitHandler,window.server.HttpRequestMethod.POST,o),e.removeEventListener("submit",window.form.submitHandler)},addValidationHandlers:()=>{t.addEventListener("input",p),r.addEventListener("change",f),o.addEventListener("input",f),n.addEventListener("change",y),s.addEventListener("change",h),d.addEventListener("change",w)},removeValidationHandlers:()=>{t.removeEventListener("input",p),r.removeEventListener("change",f),o.removeEventListener("input",f),n.removeEventListener("change",y),s.removeEventListener("change",h),d.removeEventListener("change",w)},reset:()=>{e.reset(),m(),v(),w(),window.imageUpload.reset(),e.removeEventListener("submit",window.form.submitHandler)}}})(),(()=>{const e=document.querySelector(".map__filters"),t=e.querySelector("#housing-type"),o=e.querySelector("#housing-price"),r=e.querySelector("#housing-rooms"),n=e.querySelector("#housing-guests"),s=e.querySelector("#housing-features"),d=[t,o,r,n],i=[e=>{const o=t.value;return"any"===o||e.offer.type===o},e=>{switch(o.value){case"middle":return e.offer.price>=1e4&&e.offer.price<=5e4;case"low":return e.offer.price<1e4;case"high":return e.offer.price>5e4;default:return!0}},e=>{const t=r.value;return"any"===t||e.offer.rooms===Number(t)},e=>{const t=n.value;return"any"===t||e.offer.guests===Number(t)},e=>{const t=s.querySelectorAll(":checked");return 0===t.length||0===[...t].map((e=>e.value)).filter((t=>!e.offer.features.includes(t))).length}],a=window.debounce((()=>{const e=window.data,t=i.reduce(((e,t)=>e.filter(t)),e).slice(0,5);window.pins.render(t)}));window.filters={addChangeHandler:()=>{e.addEventListener("change",a)},removeChangeHandler:()=>{e.removeEventListener("change",a)},reset:()=>{d.forEach((e=>{e.value="any"})),s.querySelectorAll("[type=checkbox]").forEach((e=>{e.checked=!1}))}}})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector(".ad-form"),o=t.querySelector(".ad-form__reset"),r=t.querySelectorAll("fieldset"),n=e.querySelector(".map__filters"),s=e.querySelector(".map__pin--main"),d=e=>{0===e.button&&l()},i=e=>{"Enter"===e.key&&l()},a=e=>{[...e].forEach((e=>e.disabled=!1))},c=e=>{[...e].forEach((e=>e.disabled=!0))},l=()=>{a(r),a(n.children),t.classList.remove("ad-form--disabled"),e.classList.remove("map--faded");const c=window.data.slice(0,5);window.form.setAddress(!0),window.pins.render(c),c&&window.filters.addChangeHandler(),window.form.addValidationHandlers(),t.addEventListener("submit",window.form.submitHandler),s.removeEventListener("mousedown",d),s.removeEventListener("keydown",i),s.addEventListener("mousedown",window.mainPin.move),o.addEventListener("click",u),window.imageUpload.addHandlers()},u=()=>{c(r),c(n.children),s.addEventListener("mousedown",d),s.addEventListener("keydown",i),window.form.removeValidationHandlers(),window.pins.remove(),window.cards.removePopup(),t.classList.add("ad-form--disabled"),e.classList.add("map--faded"),window.mainPin.setDefaultPosition(),s.removeEventListener("mousedown",window.mainPin.move),window.filters.removeChangeHandler(),window.form.reset(),window.filters.reset(),o.removeEventListener("click",u),window.imageUpload.removeHandlers()};u(),window.pageState={deactivate:u}})()})();